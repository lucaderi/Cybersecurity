# Malware Traffic Analysis
This page shows you how to analyze a Qakbot (Qbot) activity generated [clicking on a URL](https://www.virustotal.com/gui/url/f1cd5c2c1f1d80c9758a55d26c1124a199eda9d026cec686a20a0df67131cc31) and observing the generated network traffic.

Various tools are used to position traffic analysis across avalable open source tools options.

### Download Traffic Trace
- Download [this pcap](https://www.malware-traffic-analysis.net/2023/02/27/2023-02-27-Qakbot-infection-traffic.pcap.zip) file.
- Unzip it using [this password](https://www.malware-traffic-analysis.net/about.html)

### Using Suricata

Run Suricata as follows ```suricata -l logs/ -k none -r 2023-02-27-Qakbot-infection-traffic.pcap```

Analyze results using 
```
echo "Suricata event types:" ; jq -r .event_type logs/eve.json | sort | uniq -c |sort -rn
echo "Alerts:" ; grep '"event_type":"alert"' logs/eve.json | jq .alert.signature | sort -rn | uniq -c | sort -rn 
echo "TLS SNIs:" ; jq 'select(.event_type=="tls")' logs/eve.json | jq .tls.sni | sort -rn | uniq -c | sort -rn 
echo "TLS Versions:"; jq 'select(.event_type=="tls")' logs/eve.json | jq .tls.version | sort -rn | uniq -c | sort -rn
echo "HTTP Hostnames:" ; jq 'select(.event_type=="http")' logs/eve.json | jq .http.hostname | sort -rn | uniq -c | sort -rn 
echo "DNS Queries:" ; jq 'select(.event_type=="dns" )' logs/eve.json | jq .dns.rrname | sort -rn | uniq -c | sort -rn
echo "Filetransfer protocols:" ; jq 'select(.event_type=="fileinfo" )' logs/eve.json | jq .app_proto | sort -rn | uniq -c | sort -rn 
echo "Filenames:" ; jq 'select(.event_type=="fileinfo")' logs/eve.json | jq .fileinfo.filename | sort -rn | uniq -c | sort -rn
echo "File magic:" ; jq 'select(.event_type=="fileinfo")' logs/eve.json | jq .fileinfo.magic | sort -rn | uniq -c | sort -rn 
echo "Kerberos snames:" ; jq 'select(.event_type=="smb" and .smb.command=="SMB2_COMMAND_SESSION_SETUP" and .smb.status=="STATUS_SUCCESS" )' logs/eve.json | jq .smb.kerberos.snames[1] | uniq -c | sort -rn 
echo "Kerberos realm:" ; jq 'select(.event_type=="smb" and .smb.command=="SMB2_COMMAND_SESSION_SETUP" and .smb.status=="STATUS_SUCCESS" )'  logs/eve.json | jq .smb.kerberos.realm | uniq -c | sort -rn 
echo "SMB hostnames:" ; jq 'select(.event_type=="smb" and .smb.command=="SMB1_COMMAND_SESSION_SETUP_ANDX" and .smb.status=="STATUS_SUCCESS" and .smb.ntlmssp )' logs/eve.json | jq .smb.ntlmssp.host | uniq -c | sort -rn
echo "SMB ntlmssp version:" ; jq 'select(.event_type=="smb" and .smb.command=="SMB1_COMMAND_SESSION_SETUP_ANDX" and .smb.status=="STATUS_SUCCESS" and .smb.ntlmssp )' logs/eve.json | jq .smb.ntlmssp.version | uniq -c | sort -rn 
echo "SMB native_lm:" ; jq 'select(.event_type=="smb" and .smb.command=="SMB1_COMMAND_SESSION_SETUP_ANDX" and .smb.status=="STATUS_SUCCESS" and .smb.ntlmssp )' logs/eve.json | jq .smb.response.native_lm | uniq -c | sort -rn 
```
### Using Zeek
Run ``/opt/zeek/bin/zeek  -r 2023-02-27-Qakbot-infection-traffic.pcap``

### Using ntopng
Run ``ntopng -i 2023-02-27-Qakbot-infection-traffic.pcap``

### Using Wireshark
Run ``wireshark -i 2023-02-27-Qakbot-infection-traffic.pcap``

### Malware Notes
- [BB17 distribution Qakbot (Qbot) activity](https://isc.sans.edu/diary/BB17+distribution+Qakbot+Qbot+activity/29592/)
